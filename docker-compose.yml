version: '3.8'

services:
  ciabratop-pix:
    image: node:18-alpine
    working_dir: /app
    command: sh -c "npm install && node proxy-server.js"
    volumes:
      - /home/ciabratop:/app
    environment:
      - PORT=3000
      - NODE_ENV=production
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"

        # HTTPS
        - "traefik.http.routers.ciabratop-secure.rule=Host(`ciabra.toptvs.online`)"
        - "traefik.http.routers.ciabratop-secure.entrypoints=websecure"
        - "traefik.http.routers.ciabratop-secure.tls=true"
        - "traefik.http.routers.ciabratop-secure.tls.certresolver=letsencryptresolver"

        # HTTP â†’ HTTPS
        - "traefik.http.routers.ciabratop.rule=Host(`ciabra.toptvs.online`)"
        - "traefik.http.routers.ciabratop.entrypoints=web"
        - "traefik.http.routers.ciabratop.middlewares=ciabratop-redirect"

        - "traefik.http.middlewares.ciabratop-redirect.redirectscheme.scheme=https"

        # Service
        - "traefik.http.services.ciabratop.loadbalancer.server.port=3000"
    networks:
      - topnet

networks:
  topnet:
    external: true
